<?php
/**
 * @file
 */

/**
 * Implements hook_views_query_alter().
 * Adding term filter for subsites.
 */
function stanford_lbre_helper_views_query_alter(&$view, &$query) {
  if (($view->name == 'stanford_events_views' && $view->current_display == 'block')
  || ($view->name == 'stanford_news' && $view->current_display == 'block_2_item_recent_news_list')) {
    //cache_clear_all($view->name, 'cache_views_data', TRUE);
    if (arg(0) == 'node') {
      $nid = arg(1);
      $node = node_load($nid);
      if ($node->type == 'stanford_subsite') {
        $node_tid = $node->field_stanford_subsite_sub_tags[LANGUAGE_NONE][0]['tid'];
        $join = new views_join();
        $join->table = 'taxonomy_index';
        $join->field = 'nid';
        $join->left_table = 'node';
        $join->left_field = 'nid';
        $join->type = 'INNER';
        //add the join the the view query
        $view->query->add_relationship('taxonomy_index',$join,'node');
    
        //add the where
        $view->query->where[1]['conditions'][] = array(
            'field' => 'taxonomy_index.tid',
            'value' => $node_tid,
            'operator' => '='
        );
      }
    }
  }
}

function stanford_lbre_helper_block_info_alter(&$blocks, $theme, $code_blocks) {
  // Remove the caching on subsite blocks.
  $blocks['views']['stanford_events_views-block']['cache'] = DRUPAL_NO_CACHE;
  $blocks['views']['f73ff55b085ea49217d347de6630cd5a']['cache'] = DRUPAL_NO_CACHE;
}
